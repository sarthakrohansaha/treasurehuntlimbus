<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Team Proximity Hunt</title>
  <style>
    * {margin: 0; padding: 0; box-sizing: border-box;}
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; color: white;
    }
    .container {max-width: 1000px; margin: 0 auto; padding: 20px;}
    .header {text-align: center; margin-bottom: 30px;}
    .card {
      background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px;
      padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(31,38,135,0.37);
    }
    .admin-section {border-left: 4px solid #ff6b6b;}
    .player-section {border-left: 4px solid #4ecdc4;}
    .admin-auth {border-left: 4px solid #ff9500;}
    input, button, select, textarea {
      width: 100%; padding: 12px; margin: 8px 0;
      border: none; border-radius: 8px; font-size: 16px;
    }
    input, select, textarea {background: rgba(255, 255, 255, 0.9); color: #333;}
    button {
      background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white;
      cursor: pointer; font-weight: bold; transition: all 0.3s ease;
    }
    button:hover {transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
    button:disabled {background: #666; cursor: not-allowed; transform: none;}
    .status {padding: 15px; border-radius: 8px; margin: 10px 0; font-weight: bold;}
    .success {background: rgba(46, 204, 113, 0.3); border: 1px solid #2ecc71;}
    .error {background: rgba(231, 76, 60, 0.3); border: 1px solid #e74c3c;}
    .warning {background: rgba(241, 196, 15, 0.3); border: 1px solid #f1c40f;}
    #mapAdmin {width: 100%; height: 400px; border-radius: 10px; margin: 10px 0;}
    #map {width: 100%; height: 300px; border-radius: 10px; margin: 10px 0;}
    .hidden {display: none;}
    .admin-access {text-align: center; margin-top: 30px;}
    .admin-access-btn {
      background: rgba(255, 255, 255, 0.1); color: white;
      border: 1px solid rgba(255, 255, 255, 0.3); padding: 8px 16px;
      font-size: 14px; border-radius: 20px; cursor: pointer;
      transition: all 0.3s ease;
    }
    .admin-access-btn:hover {background: rgba(255, 255, 255, 0.2);}
    .player-list {margin-top: 10px;}
    .player-list li {
      background: rgba(255,255,255,0.2); margin: 5px; padding: 5px; border-radius: 8px;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üéØ Team Proximity Hunt</h1>
    <p>5 Players must be nearby to unlock each stage</p>
  </div>

  <!-- Admin Authentication -->
  <div id="admin-auth" class="card admin-auth hidden">
    <h2>üîê Admin Access</h2>
    <input type="password" id="adminCode" placeholder="Enter admin access code" maxlength="6">
    <button onclick="verifyAdminCode()">Access Admin Panel</button>
    <button onclick="cancelAdminAccess()" style="background: gray;">Cancel</button>
    <div id="authStatus"></div>
  </div>

  <!-- Admin Section -->
  <div id="admin-section" class="card admin-section hidden">
    <h2>üõ†Ô∏è Admin Panel</h2>

    <h3>Generate Team</h3>
    <input type="text" id="teamName" placeholder="Team Name (e.g., Fire Dragons)">
    <input type="number" id="teamSize" placeholder="Number of Members" value="5" min="2" max="10">
    <button onclick="generateTeam()">Generate Team</button>
    <div id="generatedTeamDisplay"></div>

    <h3>Set Stage</h3>
    <label>Stage Number</label>
    <select id="stageSelect">
      <option value="1">Stage 1</option>
      <option value="2">Stage 2</option>
      <option value="3">Stage 3</option>
    </select>
    <label>Stage Code (5 digits)</label>
    <input type="text" id="accessCode" maxlength="5">
    <label>Stage Clue</label>
    <textarea id="clueText"></textarea>
    <label>Proximity (meters)</label>
    <input type="number" id="proximityInput" min="10" value="50">
    <button onclick="setStageCodeAndClue()">Save Stage</button>
    <div id="adminStatus"></div>

    <h3>Live Team Locations</h3>
    <label for="teamSelect">Select Team to View:</label>
    <select id="teamSelect" onchange="updateAdminMap()">
      <option value="">-- Select Team --</option>
    </select>
    <div id="mapAdmin"></div>

    <button onclick="logoutAdmin()" style="background: gray; margin-top:10px;">Logout</button>
  </div>

  <!-- Player Section -->
  <div id="player-section" class="card player-section">
    <h2>üéÆ Player Panel</h2>
    <input type="text" id="playerId" placeholder="Enter your team member ID">
    <button onclick="loginPlayer()">Join Game</button>
    <div id="playerStatus"></div>

    <ul id="playerList" class="player-list"></ul>

    <div id="gameArea" class="hidden">
      <h3>Stage <span id="stageNumber">1</span></h3>
      <input type="text" id="playerCode" maxlength="5" placeholder="Enter 5-digit code">
      <button onclick="submitCode()">Submit Code</button>
      <div id="gameStatus"></div>
      <div id="clueArea" class="clue-display hidden"></div>
      <div id="map" class="hidden"></div>
    </div>
  </div>

  <div class="admin-access">
    <button class="admin-access-btn" onclick="showAdminAuth()">Admin Access</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>

<script>
let gameState = {
  isAdminAuthenticated: false,
  teams: {},
  players: [],
  stages: {},
  currentStage: 1
};
const ADMIN_CODE = "741245";
let map, marker, adminMap, playerMarkers = {};

// --- Admin Functions ---
function showAdminAuth() {
  document.getElementById("admin-auth").classList.remove("hidden");
  document.getElementById("adminCode").focus();
}
function verifyAdminCode() {
  const enteredCode = document.getElementById("adminCode").value.trim();
  if (enteredCode === ADMIN_CODE) {
    gameState.isAdminAuthenticated = true;
    document.getElementById("admin-auth").classList.add("hidden");
    document.getElementById("admin-section").classList.remove("hidden");
    document.getElementById("player-section").classList.add("hidden");
    showStatus("authStatus", "Access granted!", "success");
    if (!adminMap) {
      adminMap = L.map("mapAdmin").setView([20, 0], 2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(adminMap);
    }
  } else {
    showStatus("authStatus", "Invalid access code", "error");
  }
  document.getElementById("adminCode").value = "";
}
function cancelAdminAccess() {
  document.getElementById("admin-auth").classList.add("hidden");
  document.getElementById("adminCode").value = "";
  document.getElementById("authStatus").innerHTML = "";
}
function logoutAdmin() {
  gameState.isAdminAuthenticated = false;
  document.getElementById("admin-section").classList.add("hidden");
  document.getElementById("player-section").classList.remove("hidden");
}
function generateTeam() {
  const teamName = document.getElementById("teamName").value.trim();
  const teamSize = parseInt(document.getElementById("teamSize").value) || 5;
  if (!teamName) { showStatus("adminStatus", "Please enter a team name", "error"); return; }
  const teamId = teamName.replace(/\s+/g, '').substring(0, 3).toUpperCase();
  if (gameState.teams[teamId]) { showStatus("adminStatus", "Team ID already exists", "error"); return; }
  const members = [];
  for (let i = 1; i <= teamSize; i++) {
    members.push(`${teamId}${i.toString().padStart(3,"0")}`);
  }
  gameState.teams[teamId] = { name: teamName, members };
  displayGeneratedTeam(teamId, teamName, members);
  addTeamToDropdown(teamId, teamName);
  showStatus("adminStatus", `Team ${teamName} created!`, "success");
  document.getElementById("teamName").value = "";
}
function displayGeneratedTeam(teamId, teamName, members) {
  document.getElementById("generatedTeamDisplay").innerHTML = `
    <div class="team-id-display">
      <h4>${teamName} (${teamId})</h4>
      <p>Member IDs:</p>
      ${members.map(m => `<div>${m}</div>`).join("")}
    </div>`;
}
function addTeamToDropdown(teamId, teamName) {
  const teamSelect = document.getElementById("teamSelect");
  if (teamSelect.options.length <= 40) {
    const opt = document.createElement("option");
    opt.value = teamId;
    opt.textContent = `${teamName} (${teamId})`;
    teamSelect.appendChild(opt);
  }
}
function setStageCodeAndClue() {
  if (!gameState.isAdminAuthenticated) return;
  const stageNum = parseInt(document.getElementById("stageSelect").value);
  const code = document.getElementById("accessCode").value.trim();
  const clue = document.getElementById("clueText").value.trim();
  const proximity = parseInt(document.getElementById("proximityInput").value) || 50;
  if (!code || code.length !== 5) {
    showStatus("adminStatus", "Enter a valid 5-digit code", "error"); return;
  }
  gameState.stages[stageNum] = {
    code, clue, location: [28.61+stageNum*0.01,77.23+stageNum*0.01], proximity
  };
  showStatus("adminStatus", `Stage ${stageNum} saved!`, "success");
  document.getElementById("accessCode").value = "";
  document.getElementById("clueText").value = "";
}

// --- Player Functions ---
function loginPlayer() {
  const id = document.getElementById("playerId").value.trim();
  if (!id) { showStatus("playerStatus", "Enter your ID", "error"); return; }

  // One login per device
  if (localStorage.getItem("playerId")) {
    showStatus("playerStatus", "This device is already logged in as " + localStorage.getItem("playerId"), "warning");
    return;
  }

  let foundTeam = null;
  for (const teamId in gameState.teams) {
    if (gameState.teams[teamId].members.includes(id)) { foundTeam = teamId; break; }
  }
  if (!foundTeam) { showStatus("playerStatus", "Invalid team member ID", "error"); return; }

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      gameState.players.push({ id, teamId: foundTeam, lat: pos.coords.latitude, lon: pos.coords.longitude });
      localStorage.setItem("playerId", id);
      updatePlayerList();
      updateAdminMap();
      showStatus("playerStatus", `Player ${id} joined!`, "success");
      if (gameState.players.length >= 5) {
        document.getElementById("gameArea").classList.remove("hidden");
      }
      navigator.geolocation.watchPosition(p => {
        updatePlayerLocation(id, p.coords.latitude, p.coords.longitude);
      });
    }, () => showStatus("playerStatus", "Location denied", "error"));
  }
}
function updatePlayerLocation(id, lat, lon) {
  const player = gameState.players.find(p => p.id===id);
  if (player) { player.lat=lat; player.lon=lon; }
  updatePlayerList();
  updateAdminMap();
}
function updatePlayerList() {
  document.getElementById("playerList").innerHTML =
    gameState.players.map(p => `<li>${p.id} (${p.lat.toFixed(4)}, ${p.lon.toFixed(4)})</li>`).join("");
}
function updateAdminMap() {
  if (!adminMap) return;
  const teamId = document.getElementById("teamSelect").value;
  Object.values(playerMarkers).forEach(m => adminMap.removeLayer(m));
  playerMarkers = {};
  if (!teamId) return;
  gameState.players.filter(p => p.teamId===teamId).forEach(p => {
    playerMarkers[p.id] = L.marker([p.lat,p.lon]).addTo(adminMap).bindPopup(p.id);
  });
}

// --- Stage Gameplay ---
function submitCode() {
  const stage = gameState.stages[gameState.currentStage];
  if (!stage) { showStatus("gameStatus", "Stage not set!", "error"); return; }
  if (!allPlayersNearby(stage)) {
    showStatus("gameStatus", `All 5 players must be within ${stage.proximity}m!`, "warning"); return;
  }
  const code = document.getElementById("playerCode").value.trim();
  if (code === stage.code) {
    showStatus("gameStatus", "Correct code!", "success");
    showClue(stage.clue, stage.location);
    if (gameState.currentStage < Object.keys(gameState.stages).length) {
      gameState.currentStage++;
      document.getElementById("stageNumber").textContent = gameState.currentStage;
    } else { showVictory(); }
  } else { showStatus("gameStatus", "Wrong code!", "error"); }
  document.getElementById("playerCode").value = "";
}
function allPlayersNearby(stage) {
  if (gameState.players.length < 5) return false;
  const maxDist = stage.proximity || 50;
  for (let i=0;i<gameState.players.length;i++){
    for (let j=i+1;j<gameState.players.length;j++){
      if (distance(gameState.players[i], gameState.players[j]) > maxDist) return false;
    }
  }
  return true;
}
function showClue(clue, location) {
  const clueArea = document.getElementById("clueArea");
  clueArea.classList.remove("hidden");
  clueArea.innerHTML = `<h3>Clue</h3><p>${clue}</p>`;
  document.getElementById("map").classList.remove("hidden");
  if (!map) {
    map = L.map("map").setView(location, 14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
  }
  if (marker) marker.remove();
  marker = L.marker(location).addTo(map).bindPopup("Next Location").openPopup();
  map.setView(location, 14);
}
function showVictory() {
  const clueArea = document.getElementById("clueArea");
  clueArea.classList.remove("hidden");
  clueArea.innerHTML = `<h2>üèÜ Congratulations!</h2><p>Your team completed the hunt!</p>`;
  document.getElementById("map").classList.add("hidden");
}

// --- Utilities ---
function showStatus(elementId, message, type) {
  const el = document.getElementById(elementId);
  el.innerHTML = `<div class="status ${type}">${message}</div>`;
  setTimeout(() => { el.innerHTML = ""; }, 4000);
}
function distance(p1,p2) {
  const R=6371000;
  const dLat=(p2.lat-p1.lat)*Math.PI/180;
  const dLon=(p2.lon-p1.lon)*Math.PI/180;
  const lat1=p1.lat*Math.PI/180, lat2=p2.lat*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.sin(dLon/2)**2 * Math.cos(lat1)*Math.cos(lat2);
  return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
</script>
</body>
</html>
